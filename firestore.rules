rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function: Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function: Check if user owns the resource
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // User documents and all subcollections
    match /users/{userId} {
      // Users can read and write their own user document
      allow read, write: if isOwner(userId);
      
      // User subcollections - only owner can access
      match /profile/{profileId} {
        allow read, write: if isOwner(userId);
      }
      
      match /tasks/{taskId} {
        allow read, write: if isOwner(userId);
      }
      
      match /projects/{projectId} {
        function ownerId() {
          return resource.data.ownerId != null ? resource.data.ownerId : userId;
        }

        allow read: if isSignedIn() && (
          isOwner(userId) ||
          (resource.data.teamMemberIds != null && request.auth.uid in resource.data.teamMemberIds)
        );

        allow create: if isOwner(userId) &&
          request.resource.data.ownerId == request.auth.uid &&
          request.resource.data.teamMemberIds != null &&
          request.resource.data.teamMemberIds.size() > 0 &&
          request.auth.uid in request.resource.data.teamMemberIds;

        allow update: if
          request.resource.data.ownerId == ownerId() &&
          request.resource.data.teamMemberIds != null &&
          request.resource.data.teamMemberIds.size() > 0 &&
          ownerId() in request.resource.data.teamMemberIds &&
          (
            // Owners can update any fields
            isOwner(userId) ||
            (
              // Project members can update non-membership fields
              resource.data.teamMemberIds != null &&
              request.auth.uid in resource.data.teamMemberIds &&
              request.resource.data.teamMemberIds == resource.data.teamMemberIds
            )
          );

        allow delete: if isOwner(userId);
      }
      
      match /leads/{leadId} {
        allow read, write: if isOwner(userId);
      }
      
      match /dashboard/{dashboardId} {
        allow read, write: if isOwner(userId);
      }
      
      match /teamMembers/{memberId} {
        allow read, write: if isOwner(userId);
      }
      
      match /notifications/{notificationId} {
        allow read, write: if isOwner(userId);
      }
      
      match /scheduledPosts/{postId} {
        allow read, write: if isOwner(userId);
      }
      
      match /socialStats/{statId} {
        allow read, write: if isOwner(userId);
      }
      
      match /analytics/{analyticsId} {
        allow read, write: if isOwner(userId);
      }
      
      // User-specific channels (for demo data)
      match /channels/{channelId} {
        allow read, write: if isOwner(userId);
        match /messages/{messageId} {
          allow read, write: if isOwner(userId);
        }
      }
      
      // Automation settings
      match /automation/{docId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // Global Channels collection - member-based access
    match /channels/{channelId} {
      // Read: User must be a member of the channel
      allow read: if isSignedIn() && 
        request.auth.uid in resource.data.members;
      
      // Create: User must be authenticated and set themselves as creator
      allow create: if isSignedIn() && 
        request.auth.uid == request.resource.data.createdBy;
      
      // Update: Creator or any member can update
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.createdBy ||
        request.auth.uid in resource.data.members
      );
      
      // Delete: Creator can delete, or members can delete if it's their demo data
      allow delete: if isSignedIn() && (
        request.auth.uid == resource.data.createdBy ||
        request.auth.uid in resource.data.members
      );
      
      // Messages subcollection
      match /messages/{messageId} {
        // Read: User must be a member of the parent channel
        allow read: if isSignedIn() && 
          request.auth.uid in get(/databases/$(database)/documents/channels/$(channelId)).data.members;
        
        // Create: User must be authenticated and sender.id must match auth.uid
        allow create: if isSignedIn() && 
          request.auth.uid == request.resource.data.sender.id;
        
        // Update/Delete: Sender can modify their own messages, or if senderId matches
        allow update, delete: if isSignedIn() && (
          request.auth.uid == resource.data.sender.id ||
          request.auth.uid == resource.data.senderId ||
          request.auth.uid in get(/databases/$(database)/documents/channels/$(channelId)).data.members
        );
      }
    }
    
    // Project invites collection
    match /projectInvites/{inviteId} {
      // Read: Invited user or inviter can read
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.invitedBy ||
        request.auth.uid == resource.data.invitedUser
      );
      
      // Create: User must be authenticated and set themselves as inviter
      allow create: if isSignedIn() && 
        request.auth.uid == request.resource.data.invitedBy;
      
      // Update: Invited user or inviter can update (for accept/decline)
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.invitedUser ||
        request.auth.uid == resource.data.invitedBy
      );
      
      // Delete: Only inviter can delete
      allow delete: if isSignedIn() && 
        request.auth.uid == resource.data.invitedBy;
    }

    // Public directory of basic user information for collaboration features
    match /userDirectory/{directoryUserId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isOwner(directoryUserId);
    }
    
    // Slack integrations - top-level collection
    // Document ID is the userId for easy lookup
    match /slackIntegrations/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Meeting notes - top-level collection with userId field
    match /meetingNotes/{meetingId} {
      // Read: User must own the meeting note
      allow read: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
      
      // Create: User must be authenticated and set themselves as owner
      allow create: if isSignedIn() && 
        request.resource.data.userId == request.auth.uid;
      
      // Update: Only owner can update
      allow update: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
      
      // Delete: Only owner can delete
      allow delete: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
    }
    
    // Global leads collection (for imports from HubSpot, CSV, etc.)
    match /leads/{leadId} {
      // Read: User must own the lead
      allow read: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
      
      // Create: User must be authenticated and set themselves as owner
      allow create: if isSignedIn() && 
        request.resource.data.userId == request.auth.uid;
      
      // Update: Only owner can update
      allow update: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
      
      // Delete: Only owner can delete
      allow delete: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
    }
    
    // Global tasks collection (for AI CRUD operations)
    match /tasks/{taskId} {
      // Read: User must own or be assigned the task
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        resource.data.assignedTo == request.auth.uid
      );
      
      // Create: User must be authenticated and set themselves as owner
      allow create: if isSignedIn() && 
        request.resource.data.userId == request.auth.uid;
      
      // Update: Owner or assignee can update
      allow update: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        resource.data.assignedTo == request.auth.uid
      );
      
      // Delete: Only owner can delete
      allow delete: if isSignedIn() && 
        resource.data.userId == request.auth.uid;
    }
  }
}
